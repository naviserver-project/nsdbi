#
# Test Suite
#


package require tcltest 2.2
namespace import -force ::tcltest::*

eval ::tcltest::configure $argv



test basic-syntax.1 {check the basic syntax and arg handling} -body {
    dbi
} -returnCodes error -result {wrong # args: should be "dbi command ?args?"}

test basic-syntax.2 {check the basic syntax and arg handling} -body {
    dbi ?
} -returnCodes error -result {bad command "?": must be 0or1row, 1row, bounce, default, dml, info, pools, releasehandles, rows, or stats}



test pools {list all pools} -body {
    lsort [dbi pools]
} -result {pool1 pool2}


test default {default pool} -body {
    dbi default
} -result pool1



test info.1 {pool info} -body {
    dbi info [dbi default]
} -cleanup {
    unset -nocomplain a
} -result {driver drivername database dbname datasource ::datasource1 description {Pool One Description} user username1 connections 5}



test stats.1 {pool stats} -body {
     array set a [dbi stats pool1]
     lsort [array names a]
} -cleanup {
    unset -nocomplain a
} -result {agedcloses bounces handlefailures handlegets handlemisses handleopens idlecloses oppscloses queries}


test 0or1row-1 {found single column} -body {
    dbi 0or1row {1 1}
} -result v

test 0or1row-2 {found multiple columns} -body {
    dbi 0or1row {1 3}
} -result {v v v}

test 0or1row-3 {not found} -body {
    dbi 0or1row {0 1}
} -result {}

test 0or1row-4 {query error} -body {
    dbi 0or1row {ERROR}
} -returnCodes error -result {nsdbitest error}



test 1row-1 {found single column} -body {
    dbi 1row {1 1}
} -result v

test 1row-2 {found multiple columns} -body {
    dbi 1row {1 3}
} -result {v v v}

test 1row-3 {1row not found} -body {
    dbi 1row {0 0}
} -returnCodes error -result "query was not a statement returning rows"

test 1row-4 {query error} -body {
    dbi 1row {ERROR}
} -returnCodes error -result {nsdbitest error}


#dbi_releasehandles


test rows-1 {found 1 row, 1 column} -body {
    dbi rows {1 1}
} -result v

test rows-2 {found 1 row, 3 columns} -body {
    dbi rows {1 3}
} -result {v v v}

test rows-3 {found 2 rows, 1 column} -body {
    dbi rows {2 1}
} -result {v v}

test rows-4 {no rows} -body {
    dbi rows {0 0}
} -result {}

test rows-5 {query error} -body {
    dbi rows {select * from noexist}
} -returnCodes error -result {nsdbitest error}



test poolb {query from pool b} -body {
    dbi rows -pool pool2 {1 1}
} -result v


test poolhandle-1 {cache pool pointer in pool name obj} -body {
    set poolname pool1
    dbi rows -pool $poolname {1 1}
    dbi rows -pool $poolname {1 1}
    set poolname
} -result pool1



cleanupTests
